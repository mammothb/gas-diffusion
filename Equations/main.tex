\documentclass[8pt, a4paper]{article}
% packages and command files
\input{include/packagescommands}
% definitions
\input{include/definitions}
\begin{document}
  Starting equations
  \begin{equation}
  \frac{\DNO}{r} \frac{d}{dr} \left (r \frac{d\CNO}{dr} \right) + \RNO = 0
  \end{equation}
  
  Simplify
  \begin{equation}
  \DNO \frac{d^2\CNO}{dr^2} + \frac{\DNO}{r} \frac{d\CNO}{dr} = - \RNO
  \end{equation}
  
  Compare to form
  \begin{equation} \label{eq:form}
  u''+P(r)u'=F(r)
  \end{equation}
  \begin{equation}
  \:u=\CNO,\:P(r)=\frac{1}{r},\:F(r)=-\frac{\RNO}{\DNO}
  \end{equation}
  
  Taylor expansion
  \begin{align*}
  u_{i+1}&=u_i+u_i'\dr+\frac{1}{2}u_i''\dr^2,\\
  u_{i-1}&=u_i-u_i'\dr+\frac{1}{2}u_i''\dr^2
  \end{align*}
  
  Central difference
  \begin{align*}
  u_i'&=\frac{u_{i+1}-u_{i-1}}{2\dr},\\
  u_i''&=\frac{u_{i+1}-2u_i+u_{i-1}}{\dr^2}
  \end{align*}
  
  Sub back into Eq. \eqref{eq:form}
  \begin{equation}
  \frac{u_{i+1}-2u_i+u_{i-1}}{h^2}+P_i\frac{u_{i+1}-u_{i-1}}{2h}=F_i,\:h=\dr
  \end{equation}
  
  where index $i$ starts at 1. 
  
  Rearrange
  \begin{equation}
  \left (1-\frac{h}{2}P_i \right)u_{i-1}+(-2)u_i+\left (1+\frac{h}{2}P_i 
  \right)u_{i+1}=h^2F_i
  \end{equation}
  \begin{equation}
  (-2)u_i=-\left (1-\frac{h}{2}P_i \right)u_{i-1}-\left (1+\frac{h}{2}P_i 
  \right)u_{i+1}+h^2F_i
  \end{equation}
  \begin{equation}
  u_i=-\frac{1}{2}\left(-\left (1-\frac{h}{2}P_i \right)u_{i-1}-\left 
  (1+\frac{h}{2}P_i \right)u_{i+1}+h^2F_i \right)
  \end{equation}
  
  Use imaginary node to approximate Neumann BCs:
  \begin{equation}
  \frac{u_2-u_0}{2h}=0 \rightarrow u_0 = u_2
  \end{equation}
  \begin{equation}
  \frac{u_{end+1}-u_{end-1}}{2h}=0 \rightarrow u_{end+1} = u_{end-1}
  \end{equation}
  
  Substitute into Eq. \eqref{eq:form} when $i=1$
  \begin{equation}
  u_1=-2u_2+h^2F_1
  \end{equation}
  
  Substitute into Eq. \eqref{eq:form} when $i=end$
  \begin{equation}
  u_{end}=-\left (1-\frac{h}{2}P_{end} \right)u_{end-1}-\left 
  (1+\frac{h}{2}P_{end} \right)u_{end+1}+h^2F_{end}
  \end{equation}
  \begin{equation}
  u_{end}=-2u_{end-1}+h^2F_{end}
  \end{equation}
  
  Solving over iterations
  \begin{equation}
  u_i^{k+1} = -\frac{1}{2}\left(-\left (1-\frac{h}{2}P_i 
  \right)u_{i-1}^{k+1}-\left (1+\frac{h}{2}P_i \right)u_{i+1}^k+h^2F_i \right)
  \end{equation}

  Split into 5 sections. Solutions are in the general form $A\ubf=B$.
  
  Let  $a_i=\frac{h}{2}P_i$.

  RBC core $r_0 < r < r_1$
  
  Governing equation:
  \begin{equation*}
  \frac{\DNO}{r}\frac{d}{dr}\left(r\frac{d\CNO}{dr}\right)-\lambda_{core}\CNO=0
  \end{equation*}
  \begin{equation*}
  F_i = \frac{\lambda_{core}u_i}{\DNO}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  u'(0)&=0\rightarrow u_1 = u_2,\\
  u_{RBC}'(r_1)&=\sigma,\:\sigma=u_{CFL}'(r_1)
  \end{align*}
  Using second-order accurate one-sided difference approximation, $j$ 
  represents indexes in CFL domain.
  \begin{align*}
  \sigma&=\frac{-3u_j+4u_{j+1}-u_{j+2}}{2h},\\
  \frac{3u_i-4u_{i-1}+u_{i-2}}{2h}&=\sigma,\\
  3u_i-4u_{i-1}+u_{i-2}&=2h\sigma
  \end{align*}
  
  \setlength{\extrarowheight}{1.25\baselineskip}
  \begin{equation}
  A=
  \begin{bmatrix}
  -2 & 1+a_2 & 0 & \cdots & \cdots & \cdots & \cdots & 0\\
  1-a_3 & -2 & 1+a_3 & \ddots & & & & \vdots\\
  0 & 1-a_4 & -2 & \ddots & \ddots & &  & \vdots\\
  \vdots & \ddots & \ddots & \ddots & \ddots & & & \vdots\\
  \vdots & & \ddots & \ddots & -2 & 1+a_{n-3} & 0 & 0 \\
  \vdots & & & \ddots & 1-a_{n-2} & -2 & 1+a_{n-2} & 0\\
  \vdots & \cdots & \cdots & \cdots & 0 & 1-a_{n-1} & -2 & 1+a_{n-1}\\
  0 & \cdots & \cdots & \cdots & \cdots & 1 & -4 & 3\\[5ex]
  \end{bmatrix},\:
  \ubf=
  \begin{bmatrix}
  u_2\\
  u_3\\
  \vdots\\
  u_i\\
  \vdots\\
  u_n
  \end{bmatrix},\:
  B=
  \begin{bmatrix}
  h^2F_2-(1-a_2)u_1\\
  h^2F_3\\
  \vdots\\
  h^2F_i\\
  \vdots\\
  h^2F_{n-1}\\
  2h\sigma
  \end{bmatrix}
  \end{equation}

  CFL $r_1<r<r_2$
  
  Governing equation
  \begin{equation*}
  \frac{\DNO}{r}\frac{d}{dr}\left(r\frac{d\CNO}{dr}\right)=0
  \end{equation*}
  \begin{equation*}
  F_i=\frac{0}{\DNO}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  u_{CFL}(r_1)&=u_{RBC}(r_1),\\
  u_{CFL}'(r_2)&=\phi,\:\phi=u_{EC}'(r_2),\\
  \end{align*}
  
  Using one-sided difference approximation again, $i$ is CFL, $j$ is RBC.
  \begin{align*}
  \phi&=\frac{-3u_k+4u_{k+1}-u_{k+2}}{2h},\\
  \frac{3u_i-4u_{i-1}+u_{i-2}}{2h}&=\phi,\\
  3u_i-4u_{i-1}+u_{i-2}&=2h\phi
  \end{align*}
  \begin{equation}
  A=
  \begin{bmatrix}
  -2 & 1+a_2 & 0 & & & & & 0\\
  1-a_3 & -2 & 1+a_3 & \ddots & & & & \vdots\\
  0 & 1-a_4 & -2 & \ddots & \ddots & &  & \vdots\\
  \vdots & \ddots & \ddots & \ddots & \ddots & & & \vdots\\
  \vdots & & \ddots & \ddots & -2 & 1+a_{n-3} & 0 & 0\\
  \vdots & & & \ddots & 1-a_{n-2} & -2 & 1+a_{n-2} & 0\\
  \vdots & \cdots & \cdots & \cdots & 0 & 1-a_{n-1} & -2 & 1+a_{n-1}\\
  0 & \cdots & \cdots & \cdots & \cdots & 1 & -4 & 3\\[5ex]
  \end{bmatrix},\:
  \ubf=
  \begin{bmatrix}
  u_2\\
  u_3\\
  \vdots\\
  u_i\\
  \vdots\\
  u_n
  \end{bmatrix},\:
  B=
  \begin{bmatrix}
  h^2F_2-(1-a_2)u_1\\
  h^2F_3\\
  \vdots\\
  h^2F_i\\
  \vdots\\
  h^2F_{n-1}\\
  2h\phi
  \end{bmatrix}
  \end{equation}
  
  EC $r_2<r<r_3$ is same method as CFL, only difference is in the \RNO term.
  
  Governing equation
  \begin{equation*}
  \frac{\DNO}{r}\frac{d}{dr}\left(r\frac{d\CNO}{dr}\right)+\RNO=0
  \end{equation*}
  \begin{equation*}
  F_i=-\frac{R_{NO_{max}}}{\DNO}\frac{P_{O_2}}{P_{O_2}+K_{m,eNOS}}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  u_{EC}(r_2)&=u_{CFL}(r_2),\\
  u_{EC}'(r_3)&=\gamma,\:\gamma=u_{VW}'(r_3)
  \end{align*}
  
  VW $r_3<r<r_4$ is same method as CFL, only difference is in the $R_{O_2}$ 
  term.
  
  Governing equation
  \begin{equation*}
  \frac{\DNO}{r}\frac{d}{dr}\left(r\frac{d\CNO}{dr}\right)-\lambda_{vw,t}\CNO=0
  \end{equation*}
  \begin{equation*}
  F_i=\frac{\lambda_{vw,t}u_i}{\DNO}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  u_{VW}(r_3)&=u_{EC}(r_3),\\
  u_{VW}'(r_4)&=\delta,\:\delta=u_{T}'(r_4)
  \end{align*}

  T $r_4<r<r_5$. Combined since same governing equation.
  Governing equation
  \begin{equation*}
  \frac{\DNO}{r}\frac{d}{dr}\left(r\frac{d\CNO}{dr}\right)-\lambda_{vw,t}\CNO=0
  \end{equation*}
  \begin{equation*}
  F_i=\frac{\lambda_{vw,t}u_i}{\DNO}
  \end{equation*}
  \begin{align*}
  u_{T}(r_4)&=u_{VW}(r_4),\\    
  u'(r_5)&=0\rightarrow u_n=u_{n-1}
  \end{align*}
  \begin{equation}
  A=
  \begin{bmatrix}
  -2 & 1+a_2 & 0 & \cdots & \cdots & \cdots & \vdots \\
  1-a_3 & -2 & 1+a_3 & \ddots & & & \vdots \\
  0 & 1-a_4 & -2 & \ddots & \ddots & & \vdots \\
  \vdots & \ddots & \ddots & \ddots & \ddots & & \vdots \\
  \vdots & & \ddots & \ddots & -2 & 1+a_{n-3} & 0 \\
  \vdots & & & \ddots & 1-a_{n-2} & -2 & 1+a_{n-2} \\
  0 & \cdots & \cdots & \cdots & 0 & 1-a_{n-1} & -2 \\[5ex]
  \end{bmatrix},\:
  \ubf=
  \begin{bmatrix}
  u_2\\
  u_3\\
  \vdots\\
  u_i\\
  \vdots\\
  u_{n-1}
  \end{bmatrix},\:
  B=
  \begin{bmatrix}
  h^2F_2-(1-a_2)u_1\\
  h^2F_3\\
  \vdots\\
  h^2F_i\\
  \vdots\\
  h^2F_{n-1}-(1+a_{n-1})u_n
  \end{bmatrix}
  \end{equation}
  
  $O_2$ is solved using the same matrix as $NO$ except in RBC where it has a 
  constant partial pressure.
  
  RBC core $r_0 < r < r_1$
  \begin{equation*}
  P_{O_2}=70
  \end{equation*}
  
  CFL $r_1<r<r_2$
  
  Governing equation
  \begin{equation*}
  \alpha\frac{D_{O_2}}{r}\frac{d}{dr}\left(r\frac{dP_{O_2}}{dr}\right)=0
  \end{equation*}
  \begin{equation*}
  F_i=\frac{0}{\alpha D_{O_2}}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  v_{CFL}(r_1)&=v_{RBC}(r_1),\\
  v_{CFL}'(r_2)&=\phi,\:\phi=v_{EC}'(r_2)
  \end{align*}
  
  EC $r_2<r<r_3$

  Governing equation
  \begin{equation*}
  \alpha\frac{D_{O_2}}{r}\frac{d}{dr}\left(r\frac{dP_{O_2}}{dr}\right)-\RNO=0
  \end{equation*}
  \begin{equation*}
  F_i=\frac{R_{NO_{max}}}{\alpha D_{O_2}}\frac{P_{O_2}}{P_{O_2}+K_{m,eNOS}}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  v_{EC}(r_2)&=v_{CFL}(r_2),\\
  v_{EC}'(r_3)&=\gamma,\:\gamma=v_{VW}'(r_3)
  \end{align*}
  
  VW $r_3<r<r_4$
  
  Governing equation
  \begin{equation*}
  \alpha\frac{D_{O_2}}{r}\frac{d}{dr}\left(r\frac{dP_{O_2}}{dr}\right)-Q_{O_2\:
  max\:VW}\frac{P_{O_2}}{P_{O_2}+appK_m}=0
  \end{equation*}
  \begin{equation}
  appK_m=K_m\left(1+\frac{\CNO}{C_{ref}}\right)
  \end{equation}
  \begin{equation*}
  F_i=\frac{Q_{O_2\:max\:VW}}{\alpha 
  D_{O_2}}\frac{P_{O_2}}{P_{O_2}+K_m\left(1+\frac{u_i}{C_{ref}}\right)}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  v_{VW}(r_3)&=v_{EC}(r_3),\\
  v_{VW}'(r_4)&=\delta,\:\delta=v_{T}'(r_4)
  \end{align*}
  
  T $r_4<r<r_5$
  
  Governing equation
  \begin{equation*}
  \alpha\frac{D_{O_2}}{r}\frac{d}{dr}\left(r\frac{dP_{O_2}}{dr}\right)-Q_{O_2\:
    max\:T}\frac{P_{O_2}}{P_{O_2}+appK_m}=0
  \end{equation*}
  \begin{equation}
  appK_m=K_m\left(1+\frac{\CNO}{C_{ref}}\right)
  \end{equation}
  \begin{equation*}
  F_i=\frac{Q_{O_2\:max\:T}}{\alpha 
    D_{O_2}}\frac{P_{O_2}}{P_{O_2}+K_m\left(1+\frac{u_i}{C_{ref}}\right)}
  \end{equation*}
  
  Boundary condition:
  \begin{align*}
  v_{T}(r_4)&=v_{VW}(r_4),\\
  v_{T}'(r_5)&=0\rightarrow v_n=v_{n-1}
  \end{align*}
  
  \setlength{\extrarowheight}{1.25\baselineskip}
  \begin{equation}
  A=
  \begin{bmatrix}
  -2 & 1+a_2 & 0 & \cdots & \cdots & \cdots & \cdots & 0\\
  1-a_3 & -2 & 1+a_3 & \ddots & & & & \vdots\\
  0 & 1-a_4 & -2 & \ddots & \ddots & &  & \vdots\\
  \vdots & \ddots & \ddots & \ddots & \ddots & & & \vdots\\
  \vdots & & \ddots & \ddots & -2 & 1+a_{n-3} & 0 & 0 \\
  \vdots & & & \ddots & 1-a_{n-2} & -2 & 1+a_{n-2} & 0\\
  \vdots & \cdots & \cdots & \cdots & 0 & 1-a_{n-1} & -2 & 1+a_{n-1}\\
  0 & \cdots & \cdots & \cdots & \cdots & 1 & -4 & 3\\[5ex]
  \end{bmatrix},\:
  \vbf=
  \begin{bmatrix}
  v_2\\
  v_3\\
  \vdots\\
  v_i\\
  \vdots\\
  v_n
  \end{bmatrix},\:
  B=
  \begin{bmatrix}
  h^2G_2-(1-a_2)v_1\\
  h^2G_3\\
  \vdots\\
  h^2G_i\\
  \vdots\\
  h^2G_{n-1}\\
  0
  \end{bmatrix}
  \end{equation}
\end{document}